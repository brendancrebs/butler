pipeline {
    agent none
    options {
        timeout(time: 20, unit: 'MINUTES')
    }
    stages {
        stage('Lint and Test') {
            agent {
                kubernetes {
                yamlFile './ci/build-agent.yaml'
                defaultContainer 'butler-builder'
                }
            }
            environment {
                ARTIFACTORY_ACCOUNT = credentials('artifactory-service-account')
                BITBUCKET_ACCESS_TOKEN = credentials('bitbucket-access-token')
            }
            steps {
                sh 'cd code && golangci-lint run --timeout 5m --allow-parallel-runners --concurrency=1 .'
                sh 'cd code && go run ../ci/go_testing_command/go_testing_command.go'

                sh 'cd code/butler && golangci-lint run --timeout 5m --allow-parallel-runners --concurrency=1 .'
                sh 'cd code/butler && go run ../../ci/go_testing_command/go_testing_command.go'

                sh 'cd code/butler/builtin && golangci-lint run --timeout 5m --allow-parallel-runners --concurrency=1 .'
                sh 'cd code/butler/builtin && go run ../../ci/go_testing_command/go_testing_command.go'
            }
        }
    }
}